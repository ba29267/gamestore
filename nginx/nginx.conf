upstream auth_backend {
  server auth-service:3001;
}

upstream game_backend {
  server game-service:3002;
}

upstream orders_backend {
  server orders-service:3003;
}

upstream reviews_backend {
  server reviews-service:3004;
}

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=100r/m;
limit_req_zone $binary_remote_addr zone=search_limit:10m rate=100r/m;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=30r/m;

# IP whitelist for specific endpoints (optional)
geo $ip_whitelist {
  default 0;
  127.0.0.1 1;
  192.168.0.0/16 1;
}

server {
  listen 80;
  server_name _;

  # Logging
  access_log /var/log/nginx/access.log combined;
  error_log /var/log/nginx/error.log warn;

  # Gzip compression
  gzip on;
  gzip_types application/json text/plain text/xml;
  gzip_min_length 1000;

  # Security headers
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "no-referrer-when-downgrade" always;

  # Request size limit
  client_max_body_size 10M;

  # ============================================
  # HEALTH CHECK
  # ============================================
  location /health {
    access_log off;
    return 200 '{"status":"ok"}';
    add_header Content-Type application/json;
  }

  # ============================================
  # PROMETHEUS METRICS (Protected)
  # ============================================
  location /metrics {
    if ($ip_whitelist = 0) {
      return 403;
    }
    access_log off;
    proxy_pass http://game_backend/metrics;
  }

  # ============================================
  # SWAGGER/OPENAPI DOCUMENTATION
  # ============================================
  location /docs {
    root /usr/share/nginx/html;
    try_files $uri /swagger-ui.html =404;
  }

  location /docs/swagger-ui {
    proxy_pass http://game_backend/docs/swagger-ui;
    proxy_set_header Host $host;
  }

  # ============================================
  # AUTH SERVICE (30 req/min limit)
  # ============================================
  location /api/v1/auth/ {
    limit_req zone=auth_limit burst=5 nodelay;
    
    proxy_pass http://auth_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id;
    
    # Timeouts
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
  }

  # ============================================
  # GAME SERVICE (100 req/min limit)
  # ============================================
  location /api/v1/games {
    limit_req zone=general_limit burst=10 nodelay;
    
    proxy_pass http://game_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id;
    
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
  }

  # Search endpoint with stricter rate limiting
  location /api/v1/games/search {
    limit_req zone=search_limit burst=5 nodelay;
    
    proxy_pass http://game_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id;
    
    proxy_connect_timeout 5s;
    proxy_send_timeout 15s;
    proxy_read_timeout 15s;
  }

  # GraphQL endpoint
  location /graphql {
    proxy_pass http://game_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id;
    
    proxy_connect_timeout 5s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
  }

  # ============================================
  # ORDERS SERVICE (100 req/min limit)
  # ============================================
  location /api/v1/orders {
    limit_req zone=general_limit burst=10 nodelay;
    
    proxy_pass http://orders_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id;
    
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
  }

  # ============================================
  # REVIEWS SERVICE (100 req/min limit)
  # ============================================
  location /api/v1/reviews {
    limit_req zone=general_limit burst=10 nodelay;
    
    proxy_pass http://reviews_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id;
    
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
  }

  # ============================================
  # CATCH-ALL (routing by path prefix)
  # ============================================
  location /api/v1/ {
    limit_req zone=general_limit burst=10 nodelay;
    
    # Route based on path
    if ($uri ~ ^/api/v1/auth/) {
      proxy_pass http://auth_backend;
    }
    if ($uri ~ ^/api/v1/games) {
      proxy_pass http://game_backend;
    }
    if ($uri ~ ^/api/v1/orders) {
      proxy_pass http://orders_backend;
    }
    if ($uri ~ ^/api/v1/reviews) {
      proxy_pass http://reviews_backend;
    }

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id;
  }

  # ============================================
  # NOT FOUND
  # ============================================
  location / {
    return 404 '{"error":"Not Found","statusCode":404}\n';
    add_header Content-Type application/json;
  }

  # ============================================
  # ERROR HANDLING
  # ============================================
  error_page 502 /502.json;
  location = /502.json {
    access_log off;
    return 502 '{"error":"Bad Gateway","statusCode":502}\n';
    add_header Content-Type application/json;
  }

  error_page 503 /503.json;
  location = /503.json {
    access_log off;
    return 503 '{"error":"Service Unavailable","statusCode":503}\n';
    add_header Content-Type application/json;
  }

  error_page 504 /504.json;
  location = /504.json {
    access_log off;
    return 504 '{"error":"Gateway Timeout","statusCode":504}\n';
    add_header Content-Type application/json;
  }
}
